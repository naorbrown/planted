---
import PageLayout from './PageLayout.astro';
import Breadcrumb from '../components/ui/Breadcrumb.astro';
import RelatedContent from '../components/ui/RelatedContent.astro';
import { url } from '../lib/utils';
import { getCollection } from 'astro:content';

interface Props {
  guide: {
    id: string;
    data: {
      title: string;
      description: string;
      relatedPlants?: string[];
    };
  };
}

const { guide } = Astro.props;
const { title, description, relatedPlants = [] } = guide.data;

const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'I Need a Plant For...', href: '/guides/' },
  { label: title },
];

// Resolve relatedPlants slugs to actual plant data
const allPlants = await getCollection('plants', ({ data }) => !data.draft);
const relatedItems = relatedPlants
  .map((slug) => allPlants.find((p) => p.id === slug))
  .filter(Boolean)
  .map((plant) => ({
    href: url(`/plants/${plant!.id}/`),
    title: plant!.data.title,
    description: plant!.data.description,
    category: plant!.data.category,
    petSafe: plant!.data.petSafe,
    difficulty: plant!.data.difficulty,
  }));
---

<PageLayout title={title} description={description}>
  <article class="max-w-3xl mx-auto px-4 sm:px-6 py-8 sm:py-12" data-pagefind-body>
    <Breadcrumb items={breadcrumbs} />

    <div class="mt-4 mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold text-dark-text mb-2">{title}</h1>
      <p class="text-dark-text/70">{description}</p>
    </div>

    <div class="prose prose-invert max-w-none">
      <slot />
    </div>

    {relatedItems.length > 0 && (
      <RelatedContent items={relatedItems} title="Plants in This Guide" />
    )}
  </article>
</PageLayout>
